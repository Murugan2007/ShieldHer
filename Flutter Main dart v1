import 'dart:async';
import 'dart:convert';
import 'dart:math';
import 'package:flutter/material.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart';
import 'package:provider/provider.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:flutter_animate/flutter_animate.dart';
import 'package:sensors_plus/sensors_plus.dart';

// --- MAIN ENTRY POINT ---
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  final prefs = await SharedPreferences.getInstance();
  runApp(
    MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => DatabaseProvider(prefs)),
      ],
      child: const ShieldHerApp(),
    ),
  );
}

class ShieldHerApp extends StatelessWidget {
  const ShieldHerApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'ShieldHer Pro',
      theme: ThemeData(
        useMaterial3: true,
        colorScheme: ColorScheme.fromSeed(
          seedColor: const Color(0xFF6200EE),
          brightness: Brightness.light,
        ),
        scaffoldBackgroundColor: Colors.grey[50],
        appBarTheme: const AppBarTheme(
          centerTitle: true,
          elevation: 0,
          backgroundColor: Colors.transparent,
          titleTextStyle: TextStyle(color: Colors.black, fontSize: 20, fontWeight: FontWeight.bold),
          iconTheme: IconThemeData(color: Colors.black),
        ),
      ),
      home: const AuthSwitcher(),
    );
  }
}

// --- 1. LOCAL DATABASE ENGINE ---
// This acts as the backend, storing users, zones, and settings on the phone.
class DatabaseProvider extends ChangeNotifier {
  final SharedPreferences prefs;
  
  User? currentUser;
  List<DangerZone> dangerZones = [];
  
  // Developer Settings
  String openCVUrl = "http://192.168.1.10:5000/video_feed"; // Placeholder
  
  DatabaseProvider(this.prefs) {
    _loadData();
  }

  void _loadData() {
    // Load Zones
    final zonesData = prefs.getString('zones');
    if (zonesData != null) {
      final List<dynamic> decoded = jsonDecode(zonesData);
      dangerZones = decoded.map((e) => DangerZone.fromJson(e)).toList();
    } else {
      // Seed initial data for demo
      dangerZones.add(DangerZone(id: "demo1", lat: 13.0827, lng: 80.2707, radius: 200, reports: 5));
    }
    notifyListeners();
  }

  // --- AUTH LOGIC ---
  Future<bool> checkUserExists(String phone) async {
    // Developer Backdoor
    if (phone == "murugan") return true; 
    return prefs.containsKey('user_$phone');
  }

  Future<void> login(String phone) async {
    if (phone == "murugan") {
      currentUser = User(name: "Murugan (Dev)", phone: "murugan", role: "developer", trustedPhone: "");
    } else {
      final userData = prefs.getString('user_$phone');
      if (userData != null) {
        currentUser = User.fromJson(jsonDecode(userData));
      }
    }
    notifyListeners();
  }

  Future<void> register(User user) async {
    await prefs.setString('user_${user.phone}', jsonEncode(user.toJson()));
    currentUser = user;
    notifyListeners();
  }

  void logout() {
    currentUser = null;
    notifyListeners();
  }

  // --- MAP & ZONE LOGIC ---
  void reportDanger(LatLng loc) {
    // Check if location is already a hot zone
    bool found = false;
    for (var zone in dangerZones) {
      double dist = _calculateDistance(loc.latitude, loc.longitude, zone.lat, zone.lng);
      if (dist < 0.5) { // If report is within 500m of existing zone
        zone.reports += 1;
        zone.radius += 50; // Expand zone
        found = true;
        break;
      }
    }
    if (!found) {
      dangerZones.add(DangerZone(
        id: DateTime.now().millisecondsSinceEpoch.toString(),
        lat: loc.latitude,
        lng: loc.longitude,
        radius: 100, // Start small
        reports: 1,
      ));
    }
    _saveZones();
    notifyListeners();
  }

  void deleteZone(String id) {
    dangerZones.removeWhere((z) => z.id == id);
    _saveZones();
    notifyListeners();
  }

  void _saveZones() {
    final encoded = jsonEncode(dangerZones.map((e) => e.toJson()).toList());
    prefs.setString('zones', encoded);
  }

  // Simple math for distance (Haversine approx)
  double _calculateDistance(double lat1, double lon1, double lat2, double lon2) {
    var p = 0.017453292519943295;
    var c = cos;
    var a = 0.5 - c((lat2 - lat1) * p)/2 + c(lat1 * p) * c(lat2 * p) * (1 - c((lon2 - lon1) * p))/2;
    return 12742 * asin(sqrt(a));
  }
}

// --- 2. DATA MODELS ---
class User {
  String name;
  String phone;
  String role; // woman, partner, security, developer
  String? dob;
  String trustedPhone;

  User({required this.name, required this.phone, required this.role, this.dob, required this.trustedPhone});

  Map<String, dynamic> toJson() => {'name': name, 'phone': phone, 'role': role, 'dob': dob, 'trustedPhone': trustedPhone};
  factory User.fromJson(Map<String, dynamic> json) => User(
    name: json['name'], phone: json['phone'], role: json['role'], dob: json['dob'], trustedPhone: json['trustedPhone']
  );
}

class DangerZone {
  String id;
  double lat;
  double lng;
  double radius;
  int reports;

  DangerZone({required this.id, required this.lat, required this.lng, required this.radius, required this.reports});
  
  Map<String, dynamic> toJson() => {'id': id, 'lat': lat, 'lng': lng, 'radius': radius, 'reports': reports};
  factory DangerZone.fromJson(Map<String, dynamic> json) => DangerZone(
    id: json['id'], lat: json['lat'], lng: json['lng'], radius: json['radius'], reports: json['reports']
  );
}

// --- 3. SCREENS ---

class AuthSwitcher extends StatelessWidget {
  const AuthSwitcher({super.key});
  @override
  Widget build(BuildContext context) {
    final user = context.watch<DatabaseProvider>().currentUser;
    if (user == null) return const LoginScreen();
    
    switch (user.role) {
      case 'woman': return const WomanDashboard();
      case 'security': return const SecurityDashboard();
      case 'developer': return const DeveloperDashboard();
      default: return const PartnerDashboard();
    }
  }
}

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});
  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _phoneCtrl = TextEditingController();
  final _otpCtrl = TextEditingController();
  final _passCtrl = TextEditingController(); // For Developer
  bool _otpSent = false;
  bool _isDeveloper = false;

  void _checkNumber() async {
    final phone = _phoneCtrl.text.trim();
    if (phone.isEmpty) return;

    if (phone == "murugan") {
      setState(() => _isDeveloper = true);
      return;
    }

    // Simulate OTP Provider
    setState(() => _otpSent = true);
    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("OTP Sent: 1234 (Simulated)")));
  }

  void _verifyOtp() async {
    final db = context.read<DatabaseProvider>();
    
    // Developer Login
    if (_isDeveloper) {
      if (_passCtrl.text == "12345678n") {
        db.login("murugan");
      } else {
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Wrong Password")));
      }
      return;
    }

    // Normal User Login
    if (_otpCtrl.text == "1234") {
      bool exists = await db.checkUserExists(_phoneCtrl.text);
      if (exists) {
        db.login(_phoneCtrl.text);
      } else {
        Navigator.push(context, MaterialPageRoute(builder: (_) => RegistrationScreen(phone: _phoneCtrl.text)));
      }
    } else {
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Invalid OTP")));
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.shield, size: 80, color: Colors.deepPurple).animate().scale(duration: 500.ms),
            const SizedBox(height: 20),
            const Text("SHIELDHER", style: TextStyle(fontSize: 28, fontWeight: FontWeight.bold, letterSpacing: 2)),
            const SizedBox(height: 40),
            
            if (!_isDeveloper && !_otpSent) ...[
              TextField(controller: _phoneCtrl, keyboardType: TextInputType.phone, decoration: const InputDecoration(labelText: "Mobile Number", border: OutlineInputBorder(), prefixIcon: Icon(Icons.phone))),
              const SizedBox(height: 20),
              ElevatedButton(onPressed: _checkNumber, style: ElevatedButton.styleFrom(minimumSize: const Size(double.infinity, 50)), child: const Text("Continue")),
            ] else if (_isDeveloper) ...[
              TextField(controller: _passCtrl, obscureText: true, decoration: const InputDecoration(labelText: "Admin Password", border: OutlineInputBorder(), prefixIcon: Icon(Icons.lock_outline))),
              const SizedBox(height: 20),
              ElevatedButton(onPressed: _verifyOtp, style: ElevatedButton.styleFrom(backgroundColor: Colors.black, foregroundColor: Colors.white, minimumSize: const Size(double.infinity, 50)), child: const Text("Admin Login")),
            ] else ...[
              TextField(controller: _otpCtrl, keyboardType: TextInputType.number, decoration: const InputDecoration(labelText: "Enter OTP", border: OutlineInputBorder(), prefixIcon: Icon(Icons.message))),
              const SizedBox(height: 20),
              ElevatedButton(onPressed: _verifyOtp, style: ElevatedButton.styleFrom(minimumSize: const Size(double.infinity, 50)), child: const Text("Verify & Login")),
            ],
            
            if (_isDeveloper || _otpSent)
              TextButton(onPressed: () => setState(() { _otpSent = false; _isDeveloper = false; }), child: const Text("Back"))
          ],
        ),
      ),
    );
  }
}

class RegistrationScreen extends StatefulWidget {
  final String phone;
  const RegistrationScreen({super.key, required this.phone});
  @override
  State<RegistrationScreen> createState() => _RegistrationScreenState();
}

class _RegistrationScreenState extends State<RegistrationScreen> {
  final _nameCtrl = TextEditingController();
  final _dobCtrl = TextEditingController();
  final _trustCtrl = TextEditingController();
  String _role = "woman";

  void _register() {
    if (_nameCtrl.text.isEmpty) return;
    
    final user = User(
      name: _nameCtrl.text,
      phone: widget.phone,
      role: _role,
      dob: _dobCtrl.text,
      trustedPhone: _trustCtrl.text
    );
    
    context.read<DatabaseProvider>().register(user);
    Navigator.pop(context); // Go back to AuthSwitcher, which will log us in
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Create Profile")),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(24),
        child: Column(
          children: [
            DropdownButtonFormField(
              value: _role,
              items: const [
                DropdownMenuItem(value: "woman", child: Text("I am a Woman")),
                DropdownMenuItem(value: "partner", child: Text("Trusted Partner")),
                DropdownMenuItem(value: "security", child: Text("Security Guard")),
              ],
              onChanged: (val) => setState(() => _role = val.toString()),
              decoration: const InputDecoration(labelText: "Select Role", border: OutlineInputBorder()),
            ),
            const SizedBox(height: 15),
            TextField(controller: _nameCtrl, decoration: const InputDecoration(labelText: "Full Name", border: OutlineInputBorder())),
            const SizedBox(height: 15),
            
            if (_role == "woman") ...[
              TextField(controller: _dobCtrl, decoration: const InputDecoration(labelText: "Date of Birth", border: OutlineInputBorder())),
              const SizedBox(height: 15),
              TextField(controller: _trustCtrl, keyboardType: TextInputType.phone, decoration: const InputDecoration(labelText: "Trusted Contact Number", border: OutlineInputBorder(), prefixIcon: Icon(Icons.contact_phone))),
            ],
            
            const SizedBox(height: 30),
            ElevatedButton(onPressed: _register, style: ElevatedButton.styleFrom(minimumSize: const Size(double.infinity, 50)), child: const Text("Complete Registration")),
          ],
        ),
      ),
    );
  }
}

// --- 4. WOMAN DASHBOARD (With Map & Shake) ---
class WomanDashboard extends StatefulWidget {
  const WomanDashboard({super.key});
  @override
  State<WomanDashboard> createState() => _WomanDashboardState();
}

class _WomanDashboardState extends State<WomanDashboard> {
  GoogleMapController? _mapController;
  final LatLng _center = const LatLng(13.0827, 80.2707); // Default Chennai
  StreamSubscription? _shakeSub;

  @override
  void initState() {
    super.initState();
    // SHAKE DETECTION LOGIC
    _shakeSub = accelerometerEvents.listen((AccelerometerEvent event) {
      if (event.x.abs() > 15 || event.y.abs() > 15 || event.z.abs() > 15) {
        _triggerSOS();
      }
    });
  }

  @override
  void dispose() {
    _shakeSub?.cancel();
    super.dispose();
  }

  Future<void> _triggerSOS() async {
    final Uri launchUri = Uri(scheme: 'tel', path: '112');
    if (await canLaunchUrl(launchUri)) {
      await launchUrl(launchUri);
    }
  }

  @override
  Widget build(BuildContext context) {
    final db = context.watch<DatabaseProvider>();
    final Set<Circle> circles = db.dangerZones.map((z) => Circle(
      circleId: CircleId(z.id),
      center: LatLng(z.lat, z.lng),
      radius: z.radius,
      fillColor: Colors.red.withOpacity(0.3 + (min(z.reports, 10) * 0.05)), // Darker red if more reports
      strokeColor: Colors.red,
      strokeWidth: 2,
    )).toSet();

    return Scaffold(
      body: Stack(
        children: [
          // MAP LAYER
          GoogleMap(
            initialCameraPosition: CameraPosition(target: _center, zoom: 14),
            onMapCreated: (c) => _mapController = c,
            circles: circles,
            myLocationEnabled: true, // Needs permission
          ),
          
          // TOP BAR
          SafeArea(
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  FloatingActionButton.small(heroTag: "menu", backgroundColor: Colors.white, onPressed: () => db.logout(), child: const Icon(Icons.logout, color: Colors.black)),
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                    decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(20), boxShadow: [const BoxShadow(blurRadius: 5, color: Colors.black12)]),
                    child: const Row(children: [Icon(Icons.circle, color: Colors.green, size: 12), SizedBox(width: 5), Text("Active Protection")]),
                  ),
                  FloatingActionButton.small(heroTag: "report", backgroundColor: Colors.black, onPressed: () => db.reportDanger(_center), child: const Icon(Icons.warning, color: Colors.yellow)),
                ],
              ),
            ),
          ),

          // SOS BUTTON
          Align(
            alignment: Alignment.bottomCenter,
            child: Padding(
              padding: const EdgeInsets.only(bottom: 40),
              child: GestureDetector(
                onTap: _triggerSOS,
                child: Container(
                  height: 180, width: 180,
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    gradient: const LinearGradient(colors: [Colors.redAccent, Colors.deepOrange]),
                    boxShadow: [BoxShadow(color: Colors.red.withOpacity(0.5), blurRadius: 40, spreadRadius: 10)],
                  ),
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: const [
                      Icon(Icons.touch_app, size: 40, color: Colors.white),
                      Text("SOS", style: TextStyle(color: Colors.white, fontSize: 32, fontWeight: FontWeight.bold)),
                      Text("Tap or Shake", style: TextStyle(color: Colors.white70)),
                    ],
                  ),
                ).animate().pulse(duration: 1500.ms, curve: Curves.easeInOut),
              ),
            ),
          )
        ],
      ),
    );
  }
}

// --- 5. DEVELOPER DASHBOARD ---
class DeveloperDashboard extends StatelessWidget {
  const DeveloperDashboard({super.key});

  @override
  Widget build(BuildContext context) {
    final db = context.watch<DatabaseProvider>();
    return Scaffold(
      appBar: AppBar(title: const Text("Developer Console"), backgroundColor: Colors.black, foregroundColor: Colors.white, actions: [IconButton(icon: const Icon(Icons.logout), onPressed: () => db.logout())]),
      body: ListView(
        padding: const EdgeInsets.all(20),
        children: [
          _sectionHeader("Live Danger Zones"),
          ...db.dangerZones.map((z) => Card(
            child: ListTile(
              leading: const Icon(Icons.warning, color: Colors.red),
              title: Text("Zone ID: ${z.id.substring(0,5)}..."),
              subtitle: Text("Reports: ${z.reports} | Radius: ${z.radius.toInt()}m"),
              trailing: IconButton(icon: const Icon(Icons.delete), onPressed: () => db.deleteZone(z.id)),
            ),
          )),
          const SizedBox(height: 20),
          ElevatedButton.icon(
             icon: const Icon(Icons.add), 
             label: const Text("Manually Add Zone (Current Loc)"),
             onPressed: () => db.reportDanger(const LatLng(13.0827, 80.2707))
          ),

          const SizedBox(height: 30),
          _sectionHeader("OpenCV Integration"),
          Container(
            padding: const EdgeInsets.all(16),
            color: Colors.black12,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text("Camera Feed URL:"),
                const SizedBox(height: 5),
                TextField(decoration: InputDecoration(hintText: db.openCVUrl, filled: true, fillColor: Colors.white)),
                const SizedBox(height: 10),
                const Row(children: [Icon(Icons.link, color: Colors.blue), SizedBox(width: 10), Text("Status: Simulated Link Active")]),
              ],
            ),
          )
        ],
      ),
    );
  }

  Widget _sectionHeader(String title) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 10),
      child: Text(title, style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
    );
  }
}

// --- 6. SECURITY & PARTNER PLACEHOLDERS ---
class SecurityDashboard extends StatelessWidget {
  const SecurityDashboard({super.key});
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Security Monitor"), actions: [IconButton(icon: const Icon(Icons.logout), onPressed: () => context.read<DatabaseProvider>().logout())]),
      body: Column(
        children: [
          Expanded(
            flex: 2,
            child: Container(
              color: Colors.black,
              child: Center(child: Column(mainAxisAlignment: MainAxisAlignment.center, children: const [Icon(Icons.videocam, color: Colors.green, size: 60), Text("OpenCV Stream Active", style: TextStyle(color: Colors.green))])),
            ),
          ),
          const Expanded(flex: 1, child: Center(child: Text("Waiting for Alerts...")))
        ],
      ),
    );
  }
}

class PartnerDashboard extends StatelessWidget {
  const PartnerDashboard({super.key});
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Trusted Partner"), actions: [IconButton(icon: const Icon(Icons.logout), onPressed: () => context.read<DatabaseProvider>().logout())]),
      body: const Center(child: Text("You will see your family member's location here.")),
    );
  }
}
